---
title: MySQL事务
date: 2018-12-15
tags:
 - MySQL
categories:
 - 数据库
---

### Buffer Pool

内存中的一块区域，默认大小为 128 MB，保存了 MySQL 查询和写入的数据信息，其分页淘汰机制是最近最少使用。

**free链表：**单链表结构，维护 Buffer Pool 中的空页信息。当分页被填满，从free链表中的头节点移除控制块信息；当分页被清空，将分页控制块信息添加到 free 链尾部。

**flush链表：** 单链表结构，维护 Buffer Pool 中的脏页信息。当分页数据被更新时，该分页会被标记为脏页，其分页控制块信息被添加到 flush 链表尾部。MySQL 会在后台运行一个线程每隔一段时间检查 Buffer Pool 中的分页是否为脏页，当分页被标记为脏页时，线程会将分页的数据进行持久化，并将其控制块信息从flush 链表中移除。

**lru链表：** lru链表是一个固定长度的链表，当分页被使用后其控制信息会被添加到队列头部，若其已在队列中则将被移至队列首部。当lru 链表超过一定长度范围后，会淘汰链表末尾分页信息。

为了避免 Buffer Pool 的分页全局刷新，lru 链表又被分为热数据区和冷数据区，当热数据区已满，其分页信息将插入到冷数据区的头部，若已存在于冷数据区，则将被移至冷数据区头部。当冷数据区的分页前后访问 t2-t1 >1s 时，该分页控制信息将被移至热数据头部。



### Redo Log

MySQL 在安装时会默认创建两个大小为 48 MB 的 redo Log 文件： ib_logfile0 和ib_logfile1 ，记录了事务过程的每步操作信息，ib_logfile0 和 ib_logfile1 会交替进行写入。在交替写入过程中，若一个文件内容将被覆盖，MySQL 会触发 Check Point 对文件的事务操作进行持久化。

当服务器宕机重新启动后，MySQL 会首先加载 redo Log 文件，对未进行持久化的数据进行持久化。



### Log Buffer

写操作时首先把事务过程保存到 Log Buffer 中，然后根据策略刷新到 redo log 中并进行持久化。

| 配置值 | 描述                                                         |
| :----: | :----------------------------------------------------------- |
|   0    | 事务提交不立即对 redo log 进行持久化，任务交给后台线程       |
|   1    | 事务提交时，立即对 redo log 进行持久化                       |
|   2    | 事务提交时，立即将 redo log 写到操作系统缓冲区，然后定时将缓冲区事务写到 redo log 中。若出现数据库宕机，但操作系统正常，事务的持久性依然可以保持 |



### Bin Log 和 Undo Log

Bin Log 记录了是主服务器进行 主从复制调用

Undo Log 是与 redo Log 相反的操作



### Change Buffer

数据表的字段建立索引后，维护数据时需要同步维护索引，造成大量的 IO 操作。MySQL 在执行更新操作时，首先会更新数据，然后将更新操作记录到 Change Buffer 中。当 MySQL 进行查询操作时，首先会检查查询出的索引页索引是否存在于 Change Buffer 中，若存在，则更新当前索引。